# docs/db-schema.yml
# Meta-Lav Pagamentos — Contrato de Dados (Fonte Única)
# Regra: Tabelas PT-BR = runtime (canônicas). Tabelas EN = legado/read-only.

meta:
  project: "meta-lav-pagamentos"
  timezone: "UTC"
  source_of_truth: "pt-br"
  last_updated: "2026-02-05"

conventions:
  canonical_schema: "public"
  canonical_language: "pt-br"
  legacy_language: "en"
  rule:
    - "Nunca usar tabelas legacy (EN) no runtime."
    - "Toda query/endpoint deve usar nomes deste arquivo."
    - "Enum: só valores listados aqui (nada de chute)."
    - "Tabelas PT-BR são a fonte única da verdade no runtime."
    - "O YAML deve refletir o DB real (anti-ciranda)."

tables:
  # ----------------------------
  # CANÔNICAS (PT-BR) — RUNTIME
  # ----------------------------

  ciclos:
    canonical: true
    runtime: true
    table: "ciclos"
    purpose: "Estado do ciclo por máquina (AGUARDANDO_LIBERACAO -> LIBERADO -> EM_USO -> FINALIZADO) + ABORTADO"
    primary_key: ["id"]
    foreign_keys:
      - { column: "condominio_id", references: "condominios.id" }
      - { column: "maquina_id", references: "condominio_maquinas.id" }
      - { column: "pagamento_id", references: "pagamentos.id" }
    enums:
      status:
        enum_name: "ciclo_status"
        values:
          - "AGUARDANDO_LIBERACAO"
          - "LIBERADO"
          - "EM_USO"
          - "FINALIZADO"
          - "ABORTADO"
        note: "Valores verificados via meta_enum_values (DB real)."
    columns:
      id: { type: "uuid", required: true }
      pagamento_id: { type: "uuid", required: false }
      condominio_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: true }
      status: { type: "ciclo_status", required: true }
      pulso_enviado_at: { type: "timestamptz", required: false }
      busy_on_at: { type: "timestamptz", required: false }
      busy_off_at: { type: "timestamptz", required: false }
      eta_livre_at: { type: "timestamptz", required: false }
      pulso_confirmado: { type: "bool", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }
    examples:
      orphan_released_no_busy_on: |
        select id, created_at, status, pulso_enviado_at, busy_on_at, busy_off_at, maquina_id
        from ciclos
        where status = 'LIBERADO'
          and pulso_enviado_at is not null
          and busy_on_at is null
        order by pulso_enviado_at desc;

  eventos_iot:
    canonical: true
    runtime: true
    table: "eventos_iot"
    purpose: "Log canônico de eventos IoT (PULSO_ENVIADO/BUSY_ON/BUSY_OFF) ligado ao gateway e à máquina (condominio_maquinas.id)"
    primary_key: ["id"]
    foreign_keys:
      - { column: "gateway_id", references: "gateways.id" }
      - { column: "maquina_id", references: "condominio_maquinas.id" }
    enums:
      tipo:
        enum_name: "iot_evento_tipo"
        values:
          - "PULSO_ENVIADO"
          - "BUSY_ON"
          - "BUSY_OFF"
          - "HEARTBEAT"
          - "ERRO"
        note: "Valores verificados no DB."
    columns:
      id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: false }
      tipo: { type: "iot_evento_tipo", required: true }
      payload: { type: "jsonb", required: true }
      created_at: { type: "timestamptz", required: true }

  iot_commands:
    canonical: true
    runtime: true
    table: "iot_commands"
    purpose: "Fila de comandos para gateways (pulso). Vínculo com ciclo via payload.ciclo_id"
    primary_key: ["id"]
    foreign_keys:
      - { column: "gateway_id", references: "gateways.id" }
      - { column: "condominio_maquinas_id", references: "condominio_maquinas.id" }
    columns:
      id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      cmd_id: { type: "uuid", required: true }
      status: { type: "text", required: true }
      tipo: { type: "text", required: false }
      payload: { type: "jsonb", required: true }
      condominio_maquinas_id: { type: "uuid", required: false }
      ack_at: { type: "timestamptz", required: false }
      expires_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  condominio_maquinas:
    canonical: true
    runtime: true
    table: "condominio_maquinas"
    purpose: "Cadastro de máquinas por condomínio (identificador_local LAV-01/SEC-01). DB real usa coluna 'tipo' (enum tipo_maquina)."
    primary_key: ["id"]
    foreign_keys:
      - { column: "condominio_id", references: "condominios.id" }
      - { column: "gateway_id", references: "gateways.id" }
      - { column: "pos_device_id", references: "pos_devices.id" }
    enums:
      tipo:
        enum_name: "tipo_maquina"
        values:
          - "lavadora"
          - "secadora"
        note: "No DB a coluna chama 'tipo' (não 'tipo_maquina')."
    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      identificador_local: { type: "text", required: true }
      tipo: { type: "tipo_maquina", required: true }
      ativa: { type: "bool", required: false }
      duracao_ciclo_min: { type: "int", required: false }
      buffer_retirada_min: { type: "int", required: false }
      pos_device_id: { type: "uuid", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  gateways:
    canonical: true
    runtime: true
    table: "gateways"
    purpose: "Cadastro de gateways (serial, last_seen_at, telemetria). DB real usa last_seen_at (não last_seen)."
    primary_key: ["id"]
    foreign_keys:
      - { column: "condominio_id", references: "condominios.id" }
    columns:
      id: { type: "uuid", required: true }
      serial: { type: "text", required: true }
      condominio_id: { type: "uuid", required: true }
      last_seen_at: { type: "timestamptz", required: false }
      modelo: { type: "text", required: false }
      fw_version: { type: "text", required: false }
      firmware_version: { type: "text", required: false }
      ip_local: { type: "text", required: false }
      token: { type: "text", required: false }
      busy: { type: "bool", required: false }
      last_status_at: { type: "timestamptz", required: false }
      rssi: { type: "int", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }
      condominium_id: { type: "uuid", required: false } # legado/coluna duplicada (DB real)

  pos_devices:
    canonical: true
    runtime: true
    table: "pos_devices"
    purpose: "Cadastro de POS (Stone/Sunmi) por condomínio"
    primary_key: ["id"]
    foreign_keys:
      - { column: "condominio_id", references: "condominios.id" }
    columns:
      id: { type: "uuid", required: true }
      serial: { type: "text", required: true }
      condominio_id: { type: "uuid", required: true }
      stone_merchant_id: { type: "text", required: false }
      app_version: { type: "text", required: false }
      last_seen_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  pagamentos:
    canonical: true
    runtime: true
    table: "pagamentos"
    purpose: "Pagamentos (Pix/cartão). DB real usa valor_centavos + enums pag_metodo/pag_status."
    primary_key: ["id"]
    foreign_keys:
      - { column: "condominio_id", references: "condominios.id" }
      - { column: "maquina_id", references: "condominio_maquinas.id" }
      - { column: "gateway_pagamento", references: "gateways.id" }
    enums:
      metodo:
        enum_name: "pag_metodo"
        values: []   # preencher automaticamente quando você criar meta_enum_values (ou colar enum_range)
        note: "Enum real do DB. Preencher via meta_enum_values."
      status:
        enum_name: "pag_status"
        values: []   # preencher automaticamente quando você criar meta_enum_values (ou colar enum_range)
        note: "Enum real do DB. Preencher via meta_enum_values."
    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: false }
      origem: { type: "text", required: false }
      gateway_pagamento: { type: "uuid", required: false }
      valor_centavos: { type: "int", required: true }
      external_id: { type: "text", required: false }
      idempotency_key: { type: "text", required: false }
      metodo: { type: "pag_metodo", required: true }
      status: { type: "pag_status", required: true }
      paid_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  # ----------------------------
  # LEGADO (EN) — READ ONLY
  # ----------------------------

  iot_events:
    canonical: false
    runtime: false
    read_only: true
    table: "iot_events"
    purpose: "LEGADO (EN). Não usar no runtime. Logs antigos/compatibilidade."
    columns:
      id: { type: "bigint", required: true }
      serial: { type: "text", required: true }
      machine_id: { type: "text", required: true }
      event_id: { type: "text", required: true }
      type: { type: "text", required: true }
      payload: { type: "jsonb", required: true }
      created_at: { type: "timestamptz", required: true }
    rules:
      - "NÃO USAR no runtime"
      - "Somente leitura/migração"

  iot_eventos:
    canonical: false
    runtime: true
    table: "iot_eventos"
    purpose: "LEGADO local (compat). Mantido por compatibilidade; não é fonte da verdade."
    columns:
      id: { type: "uuid", required: true }
      gw_serial: { type: "text", required: true }
      ts_gw: { type: "bigint", required: true }
      tipo: { type: "text", required: true }
      payload: { type: "jsonb", required: true }
      raw_body: { type: "text", required: true }
      hmac_ok: { type: "bool", required: true }
      created_at: { type: "timestamptz", required: true }
