# docs/db-schema.yml
# Meta-Lav Pagamentos — Contrato de Dados (Fonte Única)
# Regra: Tabelas PT-BR = runtime (canônicas). Tabelas EN = legado/read-only.

meta:
  project: "meta-lav-pagamentos"
  timezone: "UTC"
  source_of_truth: "pt-br"
  last_updated: "2026-02-19"

conventions:
  canonical_schema: "public"
  canonical_language: "pt-br"
  legacy_language: "en"
  rule:
    - "Nunca usar tabelas legacy (EN) no runtime."
    - "Toda query/endpoint deve usar nomes deste arquivo."
    - "Enum: só valores listados aqui (nada de chute)."
    - "Tabelas PT-BR são a fonte única da verdade no runtime."
    - "O YAML deve refletir o DB real (anti-ciranda)."

tables:
  # ============================
  # CANÔNICAS (PT-BR) — RUNTIME
  # ============================

  ciclos:
    canonical: true
    runtime: true
    table: "ciclos"
    purpose: "Estado do ciclo por máquina"
    primary_key: ["id"]
    enums:
      status:
        enum_name: "ciclo_status"
        values:
          - "AGUARDANDO_LIBERACAO"
          - "LIBERADO"
          - "EM_USO"
          - "FINALIZADO"
          - "ABORTADO"
    columns:
      id: { type: "uuid", required: true }
      pagamento_id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: true }
      status: { type: "ciclo_status", required: true }
      pulso_enviado_at: { type: "timestamptz", required: false }
      busy_on_at: { type: "timestamptz", required: false }
      busy_off_at: { type: "timestamptz", required: false }
      eta_livre_at: { type: "timestamptz", required: false }
      pulso_confirmado: { type: "bool", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }

  eventos_iot:
    canonical: true
    runtime: true
    table: "eventos_iot"
    primary_key: ["id"]
    enums:
      tipo:
        enum_name: "iot_evento_tipo"
        values:
          - "PULSO_ENVIADO"
          - "BUSY_ON"
          - "BUSY_OFF"
          - "HEARTBEAT"
          - "ERRO"
    columns:
      id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: false }
      tipo: { type: "iot_evento_tipo", required: true }
      payload: { type: "jsonb", required: true }
      created_at: { type: "timestamptz", required: true }

  iot_commands:
    canonical: true
    runtime: true
    table: "iot_commands"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      cmd_id: { type: "uuid", required: true }
      pagamento_id: { type: "uuid", required: false }
      status: { type: "text", required: true }
      tipo: { type: "text", required: false }
      payload: { type: "jsonb", required: true }
      condominio_maquinas_id: { type: "uuid", required: false }
      ack_at: { type: "timestamptz", required: false }
      expires_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  condominio_maquinas:
    canonical: true
    runtime: true
    table: "condominio_maquinas"
    enums:
      tipo:
        enum_name: "tipo_maquina"
        values:
          - "lavadora"
          - "secadora"
    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      kit_id: { type: "uuid", required: false }
      identificador_local: { type: "text", required: true }
      tipo: { type: "tipo_maquina", required: true }
      ativa: { type: "bool", required: false }
      duracao_ciclo_min: { type: "int", required: false }
      buffer_retirada_min: { type: "int", required: false }
      pos_device_id: { type: "uuid", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  gateways:
    canonical: true
    runtime: true
    table: "gateways"
    columns:
      id: { type: "uuid", required: true }
      serial: { type: "text", required: true }
      condominio_id: { type: "uuid", required: true }
      last_seen_at: { type: "timestamptz", required: false }
      modelo: { type: "text", required: false }
      fw_version: { type: "text", required: false }
      firmware_version: { type: "text", required: false }
      ip_local: { type: "text", required: false }
      token: { type: "text", required: false }
      busy: { type: "bool", required: false }
      last_status_at: { type: "timestamptz", required: false }
      rssi: { type: "int", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  pos_devices:
    canonical: true
    runtime: true
    table: "pos_devices"
    columns:
      id: { type: "uuid", required: true }
      serial: { type: "text", required: true }
      condominio_id: { type: "uuid", required: true }
      stone_merchant_id: { type: "text", required: false }
      app_version: { type: "text", required: false }
      last_seen_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  pagamentos:
    canonical: true
    runtime: true
    table: "pagamentos"
    enums:
      metodo:
        enum_name: "pag_metodo"
        values:
          - "PIX"
          - "CARTAO"

      status:
        enum_name: "pag_status"
        values:
          - "CRIADO"
          - "PAGO"
          - "CANCELADO"
          - "ESTORNADO"
          - "EXPIRADO"
          - "FALHOU"

      origem:
        enum_name: "pag_origem"
        values:
          - "POS"
          - "APP"
        note: "PWA eliminado. Runtime só aceita POS ou APP."

      gateway_pagamento:
        enum_name: "pag_gateway"
        values:
          - "ASAAS"
          - "STONE"

    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: false }

      # DB real (vimos na prática via constraint):
      origem: { type: "pag_origem", required: true }
      gateway_pagamento: { type: "pag_gateway", required: true }
      idempotency_key: { type: "text", required: true }

      valor_centavos: { type: "int", required: true }
      external_id: { type: "text", required: false }

      metodo: { type: "pag_metodo", required: true }
      status: { type: "pag_status", required: true }

      paid_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  precos_ciclo:
    canonical: true
    runtime: true
    table: "precos_ciclo"
    purpose: "Preço vigente por máquina (histórico por vigência)"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: true }
      valor_centavos: { type: "int", required: true }
      vigente_desde: { type: "timestamptz", required: true }
      vigente_ate: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  condominios:
    canonical: true
    runtime: true
    table: "condominios"
    purpose: "Condomínios (admin e FK em gateways/maquinas/kits)"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      nome: { type: "text", required: true }
      cidade: { type: "text", required: true }
      uf: { type: "text", required: true }
      ativo: { type: "bool", required: true }
      codigo_condominio: { type: "text", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }

  kits_operacionais:
    canonical: true
    runtime: true
    table: "kits_operacionais"
    purpose: "Kit POS + Gateway por condomínio (associação operacional)"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      nome_kit: { type: "text", required: true }
      pos_device_id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      ativo: { type: "bool", required: false }
      created_at: { type: "timestamptz", required: false }

  condominio_precos:
    canonical: true
    runtime: true
    table: "condominio_precos"
    purpose: "Precificação por máquina e canal (POS/APP) com vigência a partir de"
    primary_key: ["id"]
    enums:
      canal:
        enum_name: "preco_canal"
        values:
          - "POS"
          - "APP"
    columns:
      id: { type: "uuid", required: true }
      condominio_maquina_id: { type: "uuid", required: true }
      canal: { type: "preco_canal", required: true }
      valor_centavos: { type: "int", required: true }
      vigente_a_partir: { type: "timestamptz", required: true }
      created_at: { type: "timestamptz", required: true }
      created_by: { type: "uuid", required: true }

  # ============================
  # ADMIN / ALERTAS
  # ============================

  admin_users:
    canonical: true
    runtime: true
    table: "admin_users"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      email: { type: "text", required: true }
      name: { type: "text", required: false }
      enabled: { type: "bool", required: true }
      status: { type: "text", required: true }
      password_hash: { type: "text", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }
      last_login_at: { type: "timestamptz", required: false }

  admin_roles:
    canonical: true
    runtime: true
    table: "admin_roles"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      code: { type: "text", required: true }
      name: { type: "text", required: true }
      created_at: { type: "timestamptz", required: true }

  admin_permissions:
    canonical: true
    runtime: true
    table: "admin_permissions"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      code: { type: "text", required: true }
      name: { type: "text", required: true }
      created_at: { type: "timestamptz", required: true }

  admin_user_roles:
    canonical: true
    runtime: true
    table: "admin_user_roles"
    primary_key: ["user_id", "role_id"]
    columns:
      user_id: { type: "uuid", required: true }
      role_id: { type: "uuid", required: true }
      created_at: { type: "timestamptz", required: true }

  admin_role_permissions:
    canonical: true
    runtime: true
    table: "admin_role_permissions"
    primary_key: ["role_id", "permission_id"]
    columns:
      role_id: { type: "uuid", required: true }
      permission_id: { type: "uuid", required: true }
      created_at: { type: "timestamptz", required: true }

  admin_user_permissions:
    canonical: true
    runtime: true
    table: "admin_user_permissions"
    primary_key: ["user_id", "permission_id"]
    columns:
      user_id: { type: "uuid", required: true }
      permission_id: { type: "uuid", required: true }
      allowed: { type: "bool", required: true }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }

  admin_auth_tokens:
    canonical: true
    runtime: true
    table: "admin_auth_tokens"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      user_id: { type: "uuid", required: true }
      type: { type: "text", required: true }
      token_hash: { type: "text", required: true }
      expires_at: { type: "timestamptz", required: true }
      used_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }
      created_by: { type: "uuid", required: false }

  admin_audit_log:
    canonical: true
    runtime: true
    table: "admin_audit_log"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      actor_user_id: { type: "uuid", required: false }
      action: { type: "text", required: true }
      target_user_id: { type: "uuid", required: false }
      meta: { type: "jsonb", required: true }
      created_at: { type: "timestamptz", required: true }

  alert_routes:
    canonical: true
    runtime: true
    table: "alert_routes"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      enabled: { type: "bool", required: true }
      event_code: { type: "text", required: true }
      channel: { type: "text", required: true }
      target: { type: "text", required: true }
      severity_min: { type: "text", required: true }
      dedupe_window_sec: { type: "int", required: true }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }

  alert_outbox:
    canonical: true
    runtime: true
    table: "alert_outbox"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      event_code: { type: "text", required: true }
      severity: { type: "text", required: true }
      fingerprint: { type: "text", required: true }
      channel: { type: "text", required: true }
      target: { type: "text", required: true }
      text: { type: "text", required: true }
      status: { type: "text", required: true }
      attempts: { type: "int", required: true }
      last_error: { type: "text", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }
      sent_at: { type: "timestamptz", required: false }

  alert_dispatch_log:
    canonical: true
    runtime: true
    table: "alert_dispatch_log"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      event_code: { type: "text", required: true }
      severity: { type: "text", required: true }
      fingerprint: { type: "text", required: true }
      channel: { type: "text", required: true }
      target: { type: "text", required: true }
      status: { type: "text", required: true }
      error: { type: "text", required: false }
      sent_at: { type: "timestamptz", required: true }

  alert_dlq:
    canonical: true
    runtime: true
    table: "alert_dlq"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      event_code: { type: "text", required: true }
      severity: { type: "text", required: true }
      channel: { type: "text", required: true }
      target: { type: "text", required: true }
      payload: { type: "jsonb", required: true }
      fingerprint: { type: "text", required: true }
      error: { type: "text", required: true }
      attempts: { type: "int", required: true }
      status: { type: "text", required: true }
      first_failed_at: { type: "timestamptz", required: true }
      last_failed_at: { type: "timestamptz", required: true }
      next_retry_at: { type: "timestamptz", required: true }
      resolved_at: { type: "timestamptz", required: false }
      resolved_by: { type: "text", required: false }
      notes: { type: "text", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }

  # ============================
  # LEGADO (EN) — READ ONLY
  # ============================

  iot_eventos:
    canonical: true
    runtime: false
    read_only: true
    table: "iot_eventos"
    columns:
      id: { type: "uuid", required: true }
      gw_serial: { type: "text", required: true }
      ts_gw: { type: "bigint", required: true }
      tipo: { type: "text", required: true }
      payload: { type: "jsonb", required: true }
      raw_body: { type: "text", required: true }
      hmac_ok: { type: "bool", required: true }
      created_at: { type: "timestamptz", required: true }
