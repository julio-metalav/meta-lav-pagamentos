# docs/db-schema.yml
# Meta-Lav Pagamentos — Contrato de Dados (Fonte Única)
# Regra: Tabelas PT-BR = runtime (canônicas). Tabelas EN = legado/read-only.

meta:
  project: "meta-lav-pagamentos"
  timezone: "UTC"
  source_of_truth: "pt-br"
  last_updated: "2026-02-05"

conventions:
  canonical_schema: "public"
  canonical_language: "pt-br"
  legacy_language: "en"
  rule:
    - "Nunca usar tabelas legacy (EN) no runtime."
    - "Toda query/endpoint deve usar nomes deste arquivo."
    - "Enum: só valores listados aqui (nada de chute)."
    - "Tabelas PT-BR são a fonte única da verdade no runtime."
    - "O YAML deve refletir o DB real (anti-ciranda)."

tables:
  # ============================
  # CANÔNICAS (PT-BR) — RUNTIME
  # ============================

  ciclos:
    canonical: true
    runtime: true
    table: "ciclos"
    purpose: "Estado do ciclo por máquina"
    primary_key: ["id"]
    enums:
      status:
        enum_name: "ciclo_status"
        values:
          - "AGUARDANDO_LIBERACAO"
          - "LIBERADO"
          - "EM_USO"
          - "FINALIZADO"
          - "ABORTADO"
    columns:
      id: { type: "uuid", required: true }
      pagamento_id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: true }
      status: { type: "ciclo_status", required: true }
      pulso_enviado_at: { type: "timestamptz", required: false }
      busy_on_at: { type: "timestamptz", required: false }
      busy_off_at: { type: "timestamptz", required: false }
      eta_livre_at: { type: "timestamptz", required: false }
      pulso_confirmado: { type: "bool", required: false }
      created_at: { type: "timestamptz", required: true }
      updated_at: { type: "timestamptz", required: true }

  eventos_iot:
    canonical: true
    runtime: true
    table: "eventos_iot"
    primary_key: ["id"]
    enums:
      tipo:
        enum_name: "iot_evento_tipo"
        values:
          - "PULSO_ENVIADO"
          - "BUSY_ON"
          - "BUSY_OFF"
          - "HEARTBEAT"
          - "ERRO"
    columns:
      id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: false }
      tipo: { type: "iot_evento_tipo", required: true }
      payload: { type: "jsonb", required: true }
      created_at: { type: "timestamptz", required: true }

  iot_commands:
    canonical: true
    runtime: true
    table: "iot_commands"
    primary_key: ["id"]
    columns:
      id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      cmd_id: { type: "uuid", required: true }
      status: { type: "text", required: true }
      tipo: { type: "text", required: false }
      payload: { type: "jsonb", required: true }
      condominio_maquinas_id: { type: "uuid", required: false }
      ack_at: { type: "timestamptz", required: false }
      expires_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  condominio_maquinas:
    canonical: true
    runtime: true
    table: "condominio_maquinas"
    enums:
      tipo:
        enum_name: "tipo_maquina"
        values:
          - "lavadora"
          - "secadora"
    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      gateway_id: { type: "uuid", required: true }
      identificador_local: { type: "text", required: true }
      tipo: { type: "tipo_maquina", required: true }
      ativa: { type: "bool", required: false }
      duracao_ciclo_min: { type: "int", required: false }
      buffer_retirada_min: { type: "int", required: false }
      pos_device_id: { type: "uuid", required: false }
      delivery_mode: { type: "text", required: true, default: "ACK_ONLY", note: "ACK_ONLY|BUSY_REQUIRED|ACK_PLUS_BUSY" }
      delivery_timeout_ack_sec: { type: "int", required: true, default: 10 }
      delivery_timeout_busy_sec: { type: "int", required: true, default: 15 }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  gateways:
    canonical: true
    runtime: true
    table: "gateways"
    columns:
      id: { type: "uuid", required: true }
      serial: { type: "text", required: true }
      condominio_id: { type: "uuid", required: true }
      last_seen_at: { type: "timestamptz", required: false }
      modelo: { type: "text", required: false }
      fw_version: { type: "text", required: false }
      firmware_version: { type: "text", required: false }
      ip_local: { type: "text", required: false }
      token: { type: "text", required: false }
      busy: { type: "bool", required: false }
      last_status_at: { type: "timestamptz", required: false }
      rssi: { type: "int", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  pos_devices:
    canonical: true
    runtime: true
    table: "pos_devices"
    columns:
      id: { type: "uuid", required: true }
      serial: { type: "text", required: true }
      condominio_id: { type: "uuid", required: true }
      stone_merchant_id: { type: "text", required: false }
      app_version: { type: "text", required: false }
      last_seen_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: false }
      updated_at: { type: "timestamptz", required: false }

  pagamentos:
    canonical: true
    runtime: true
    table: "pagamentos"
    enums:
      metodo:
        enum_name: "pag_metodo"
        values:
          - "PIX"
          - "CARTAO"

      status:
        enum_name: "pag_status"
        values:
          - "CRIADO"
          - "PAGO"
          - "CANCELADO"
          - "ESTORNADO"
          - "EXPIRADO"
          - "FALHOU"

      origem:
        enum_name: "pag_origem"
        values:
          - "POS"
          - "APP"
        note: "PWA eliminado. Runtime só aceita POS ou APP."

      gateway_pagamento:
        enum_name: "pag_gateway"
        values:
          - "ASAAS"
          - "STONE"

    columns:
      id: { type: "uuid", required: true }
      condominio_id: { type: "uuid", required: true }
      maquina_id: { type: "uuid", required: false }

      # DB real (vimos na prática via constraint):
      origem: { type: "pag_origem", required: true }
      gateway_pagamento: { type: "pag_gateway", required: true }
      idempotency_key: { type: "text", required: true }

      valor_centavos: { type: "int", required: true }
      external_id: { type: "text", required: false }

      metodo: { type: "pag_metodo", required: true }
      status: { type: "pag_status", required: true }

      paid_at: { type: "timestamptz", required: false }
      created_at: { type: "timestamptz", required: true }

  # ============================
  # LEGADO (EN) — READ ONLY
  # ============================

  iot_eventos:
    canonical: false
    runtime: false
    read_only: true
    table: "iot_eventos"
    columns:
      id: { type: "uuid", required: true }
      gw_serial: { type: "text", required: true }
      ts_gw: { type: "bigint", required: true }
      tipo: { type: "text", required: true }
      payload: { type: "jsonb", required: true }
      raw_body: { type: "text", required: true }
      hmac_ok: { type: "bool", required: true }
      created_at: { type: "timestamptz", required: true }
